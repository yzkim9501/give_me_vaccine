<!doctype html>
<html lang="en">
<head>

    <!-- Webpage Title -->
    <title>Home | 나 백신 맞으러 간다</title>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="shortcut icon" href="../static/vaccine.svg" type="image/x-icon">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!-- Bulma CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">

    <!--Bootstrap JS-->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
    <!-- Font Awesome CSS -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='mystyle.css') }}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo&display=swap" rel="stylesheet">
    <!-- JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
    {# 네이버 지도 API #}
    <script type="text/javascript"
            src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=4rwjk29x8l&submodules=geocoder"></script>
    <style>
        #map {
            width: 100%;
            height: 95vh;
            margin: 5px auto 5px auto;
        }

        .iw-inner {
            padding: 10px;
            font-size: smaller;
        }

        * {
            font-family: 'Nanum Myeongjo', serif;
        }

        .sidenav-left {
            height: 100%;
            width: 250px;
            position: fixed;
            z-index: 1;
            top: 4rem;
            left: 0;
            background-color: ghostwhite;
            color: black;
            overflow-x: hidden;
            padding-top: 20px;
            padding-bottom: 50px;
        }

        .sidenav-right {
            width: 200px;
            position: fixed;
            z-index: 1;
            bottom: 1rem;
            right: 1rem;
            background-color: ghostwhite;
            overflow-x: hidden;
        }

        .navitem {
            cursor: default;
            border-radius: 20px;
        }

        .centerName {
            font-weight: bold;
        }
    </style>
    <script>
        let y_cen = 37.4981125   // lat
        let x_cen = 127.0379399  // long
        let map;
        let markers = [];
        let infowindows = [];

        $(document).ready(function () {
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(y_cen, x_cen),
                zoom: 12,
                zoomControl: true,
                zoomControlOptions: {
                    style: naver.maps.ZoomControlStyle.SMALL,
                    position: naver.maps.Position.TOP_RIGHT
                }
            });
            get_centers();
            get_statistics();
        })

        function get_centers() {
            $.ajax({
                type: "GET",
                url: '/center',
                data: {},
                success: function (response) {
                    let centers = response["center_list"]
                    for (let i = 0; i < centers.length; i++) {
                        let id = centers[i]['id']
                        {# 예방 접종 센터 고유 식별자 #}
                        let centerName = centers[i]["centerName"]
                        {# 예방 접종 센터 명 #}
                        let sido = centers[i]['sido']
                        {# 시도 #}
                        let sigungu = centers[i]['sigungu']
                        {# 시군구 #}
                        let facilityName = centers[i]['facilityName']
                        {# 시설명 #}
                        let zipCode = centers[i]['zipCode']
                        {# 우편번호 #}
                        let address = centers[i]["address"]
                        {# 주소 #}
                        let lat = centers[i]['lat']
                        {# 좌표(위도) #}
                        let lng = centers[i]['lng']
                        {# 좌표(경도) #}
                        let centerType = centers[i]["centerType"]
                        {# 예방 접종 센터 유형 #}
                        let org = centers[i]['org']
                        {# 운영기관 #}
                        let phoneNumber = centers[i]['phoneNumber']
                        {# 사무실 전화번호 #}
                        let createdAt = centers[i]['createdAt']
                        {# 센터 등록 날짜 #}
                        let updatedAt = centers[i]['updatedAt']
                        {# 센터 수정 날짜 #}

                        let center = centers[i]
                        {#console.log(matjip)#}
                        {#make_card(i, matjip)#}
                        let marker = make_marker(center);
                        add_info(i, marker, center)
                    }
                }
            });
        }

        function get_statistics() {
            $.ajax({
                type: "GET",
                url: '/statistic',
                data: {},
                success: function (response) {
                    let statistics = response["statistic_list"]
                    for (let i = 0; i < statistics.length; i++) {
                        let baseDate = statistics[i]['baseDate'].split(' ')[0]
                        let sido = statistics[i]['sido']
                        let firstCnt = numberWithCommas(statistics[i]['firstCnt'])
                        let secondCnt = numberWithCommas(statistics[i]['secondCnt'])
                        let totalFirstCnt = numberWithCommas(statistics[i]['totalFirstCnt'])
                        let totalSecondCnt = numberWithCommas(statistics[i]['totalSecondCnt'])
                        let color = set_colors(i)
                        let temp_html = `
            <article class="message ${color}">
              <div class="message-header">
                <p>${sido}</p>
              </div>
              <div class="message-body">
                <p>
                    <strong>${baseDate}</strong>
                    <br>
                    <small>1차접종</small> ${firstCnt}명
                    <br>
                    <small>2차접종</small> ${secondCnt}명
                    <br>
                    <strong>전체 누적 통계</strong>
                    <br>
                    <small>1차 접종</small> ${totalFirstCnt}명
                    <br>
                    <small>2차 접종</small> ${totalSecondCnt}명
                </p>
            </div>
            </article>

`
                        $('#article-box').append(temp_html)
                    }
                }
            });
            set_colors();
        }
        function set_colors(i){
            if(i==0) return "is-primary";
            if(i<=8) return "is-success";
            return "is-warning";
        }
        function make_marker(centers) {
            let maker = '';
            {#if (matjip.like) {#}
            {#    marker = new naver.maps.Marker({#}
            {#        position: new naver.maps.LatLng(matjip["mapy"], matjip["mapx"]),#}
            {#        map: map,#}
            {#        icon: "{{ url_for('static', filename='marker-liked.png') }}"#}
            {#    });#}
            {# } else {#}
            marker = new naver.maps.Marker({
                position: new naver.maps.LatLng(centers["lat"], centers["lng"]),
                map: map,
                icon: "{{ url_for('static', filename='marker-default.png') }}"
            });
            {# }#}

            markers.push(marker)
            return marker
        }

        function add_info(i, marker, center) {
            let html_temp = `<div class="iw-inner">
                        <h5 class="centerName">${center['centerName']}</h5>
                        <p>${center['phoneNumber']}
                        </div>`;
            let infowindow = new naver.maps.InfoWindow({
                content: html_temp,
                maxWidth: 200,
                backgroundColor: "#fff",
                borderColor: "#888",
                borderWidth: 2,
                anchorSize: new naver.maps.Size(15, 15),
                anchorSkew: true,
                anchorColor: "#fff",
                pixelOffset: new naver.maps.Point(10, -10)
            });
            infowindows.push(infowindow)
            naver.maps.Event.addListener(marker, "click", function (e) {
                if (infowindow.getMap()) {
                    infowindow.close();
                } else {
                    infowindow.open(map, marker);
                    map.setCenter(infowindow.position);
                }
            });
        }

        function logout() {
            $.removeCookie('mytoken', {path: '/'});
            alert('로그아웃되었습니다.')
            window.location.href = "/login"
        }

        function numberWithCommas(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
    </script>

</head>
<body>
<nav class="navbar is-fixed-top is-white" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
        <a class="navbar-item" href="/">
            <img src="{{ url_for('static', filename='logo.png') }}">
            <strong class="is-sparta"
                    style="font-size: larger;">나 백신 맞으러 간다</strong>
        </a>
    </div>
    <div class="navbar-brand">
        <div class="navbar-item">
            <div class="buttons">
                <button class="button is-info navitem">확진 {{ occur }}</button>
                <button class="button is-success navitem">격리 해제 {{ fin }}</button>
                <button class="button is-warning navitem">격리중 {{ ing }}</button>
                <button class="button is-danger navitem">사망 {{ dead }}</button>
            </div>
        </div>
    </div>
    <div class="navbar-brand">
        <div class="navbar-item">
            <a href="javascript:logout()" style="color:#202540">로그아웃</a>
        </div>
    </div>
</nav>

<div>
    <div id="statistics" class="sidenav-left">
        <div class="box" id="article-box">
        </div>
    </div>

    <section class="accordions" class="sidenav-left" id="article-box">
    </section>
    <div id="map"></div>

    <article class="panel is-info sidenav-right">
        <p class="panel-heading">
            병원 목록
        </p>
        <p class="panel-tabs">
            <a class="is-active">나의 병원</a>
        </p>
        <a class="panel-block"> 병원 1 </a>
        <a class="panel-block"> 병원 2 </a>
        <a class="panel-block"> 병원 3 </a>
        <a class="panel-block"> 병원 4 </a>
    </article>
</div>
</body>
</html>